// ==UserScript==
// @name           クックパッドをEvernoteに送るボタン
// @namespace      https://github.com/umiiro/gmscripts
// @include        http://cookpad.com/recipe/*
// @require        http://static.evernote.com/noteit.js
// ==/UserScript==

if (window == window.top) {
	D().define();
}

function uniqid()
{
	var newDate = new Date;
	return newDate.getTime();
}

function prepare() {
	var head = document.getElementsByTagName("head")[0]
	    body = document.body;

	if (prepare.deferred) return prepare.deferred;

	prepare.deferred = parallel({
		printable: function() {
			var iframe, src, d, id;

			if (prepare.printable) return prepare.printable;

		    d = new Deferred;

			src = "http://cookpad.com/recipe/print/957016"//location.pathname.replace("recipe", "recipe/print");

			iframe = document.createElement("iframe");
			iframe.setAttribute("src", src);
			id = uniqid();
			iframe.setAttribute("id", id);
			iframe.style.display = "none";
			iframe.addEventListener("load", function(){
				prepare.printable = {
					doc: iframe.contentDocument,
					id: id
				};
				d.call(prepare.printable);
			}, false);
			prepare.printable = body.appendChild(iframe);

			return d;
		},
		noteit: function() {
			var script, d;

			if (prepare.noteit || "Evernote" in window) return null;

			d = new Deferred;

			script = document.createElement("script");
			script.setAttribute("src", "http://static.evernote.com/noteit.min.js");
			script.addEventListener("load", function(){
				prepare.noteit = true;
				d.call();
			}, false);
			head.appendChild(script);

			return d;
		}
	}).next(function(v) {
		prepare.deferred = null;
		return v;
	});

	return prepare.deferred;
}

function doClip(doc) {
	if ("Evernote" in window) {
		exec(doc.content);
	} else {
		contentEval('(' + exec + ')("' + doc.id + '");');
	}

	function exec(doc) {
		if ("string" == typeof doc) {
			var iframe = document.getElementById(doc);
			doc = iframe.contentDocument;
		}

		var title = document.title.split(/\[.*\]/)[0].trim();
		try {
		var print = doc.getElementById("print_container");

		Evernote.doClip({
			content: print,
			suggestTags: 'クックパッド',
			title: title
		});
	}
}

function addButton() {
	var img, a, li, ul, d;

	d = new Deferred;

	img = document.createElement("img");
	img.setAttribute("src", 'http://static.evernote.com/article-clipper-jp.png');
	img.setAttribute("alt", 'Evernoteにクリップ');

	a = document.createElement("a");
	a.setAttribute("href", '#');
	a.addEventListener("click", function(e){
		prepare().next(function(v){
			doClip({
				content: v.printable.doc,
				id: v.printable.id
			});
		});
		e.preventDefault();
	}, false);
	a.addEventListener("mouseover", function() {
		prepare();
	}, false);
	a.appendChild(img);

	li = document.createElement("li");
	li.appendChild(a);

	ul = document.querySelector("#_footstamp_tools>ul");

	ul.insertBefore(li, ul.firstChild);
};

function contentEval(source) {
  // Check for function input.
  if ('function' == typeof source) {
    // Execute this function with no arguments, by adding parentheses.
    // One set around the function, required for valid syntax, and a
    // second empty set calls the surrounded function.
    source = '(' + source + ')();'
  }

  // Create a script node holding this  source code.
  var script = document.createElement('script');
  script.setAttribute("type", "application/javascript");
  script.textContent = source;

  // Insert the script node into the page, so it will run, and immediately
  // remove it to clean up.
  document.body.appendChild(script);
  document.body.removeChild(script);
}

<%= IO.read("jsdeferred.userscript.js") %>